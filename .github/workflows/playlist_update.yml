name: Auto Playlist Aggregator

on:
  schedule:
    - cron: "*/5 * * * *"  # প্রতি ৫ মিনিটে চলবে
  workflow_dispatch:        # চাইলে ম্যানুয়ালি চালানো যাবে

jobs:
  update:
    runs-on: ubuntu-latest

    permissions:
      contents: write       # গিটহাবে push করার অনুমতি দেবে

    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # --- অতিরিক্ত ধাপ: Line Endings ফিক্স করা (খুবই গুরুত্বপূর্ণ) ---
      - name: Install dos2unix
        run: sudo apt-get update && sudo apt-get install -y dos2unix
        
      - name: Normalize Local Files (Line Endings)
        run: |
          echo "Fixing line endings for all local source files..."
          for file in Live_Sports Bangladesh Indian_Bangla Indian_Hindi Educational Sports Kids; do
            if [ -f "$file" ]; then
              dos2unix "$file"
              echo "Normalized line endings for $file"
            else
              echo "File $file not found. Skipping normalization."
            fi
          done

      # --- ১. playlist.m3u ফাইলটি পরিষ্কার করা (শুরুতে #EXTM3U নিশ্চিত) ---
      - name: Initialize or clean playlist.m3u
        run: |
          # নিশ্চিত করুন যে playlist.m3u ফাইলে শুধুমাত্র একটি #EXTM3U আছে
          echo "#EXTM3U" > playlist.m3u
          # Note: Local source files will be searched in the repository root.

      # --- ২. লোকাল/এক্সটার্নাল ফাইল যুক্ত করা (আপনার নতুন তালিকা অনুযায়ী) ---
      
      # Helper function (using awk for reliable content and newline handling)
      # $1: File Path, $2: Group Title
      - name: Setup M3U Append Function
        run: |
          # M3U কনটেন্টকে প্রসেস করে এবং group-title যোগ করে master playlist-এ যুক্ত করার জন্য ফাংশন
          echo 'append_m3u_group() {
            FILE_NAME="$1"
            GROUP_TITLE="$2"

            if [ -f "$FILE_NAME" ]; then
              echo "" >> playlist.m3u
              echo "# ----------- Local $GROUP_TITLE Group -----------" >> playlist.m3u
              # awk ব্যবহার করে: #EXTM3U হেডার বাদ দেওয়া, group-title যোগ করা এবং নিউলাইন নিশ্চিত করা
              awk -v title="$GROUP_TITLE" '
                !/^#EXTM3U/ {
                  if ($0 ~ /^#EXTINF:-1/) {
                    sub(/^#EXTINF:-1/, "#EXTINF:-1 group-title=\"" title "\"");
                  }
                  print $0
                }
              ' "$FILE_NAME" >> playlist.m3u
              echo "" >> playlist.m3u
              echo "Local file $FILE_NAME successfully appended."
            else
              echo "Warning: Local file $FILE_NAME not found. Skipping."
            fi
          }' >> $GITHUB_ENV

      # 1. Live Sports (Local File)
      - name: 1. Append Local Live Sports Group
        run: append_m3u_group "Live Sports" "Live Sports"

      # 2. External Link: Fancode (Group)
      - name: 2. Download and Append Fancode Playlist (External Link)
        run: |
          EXTERNAL_URL="https://raw.githubusercontent.com/IPTVFlixBD/Fancode-BD/main/playlist.m3u"
          GROUP_TITLE="Fancode"
          GROUP_NAME="$GROUP_TITLE Auto Updated"
          TEMP_FILE="fancode_temp.m3u"

          curl -L "$EXTERNAL_URL" -o "$TEMP_FILE"
          
          echo "" >> playlist.m3u
          echo "# ----------- $GROUP_NAME -----------" >> playlist.m3u
          # awk ব্যবহার করে: #EXTM3U হেডার বাদ দেওয়া, group-title যোগ করা এবং নিউলাইন নিশ্চিত করা
          awk -v title="$GROUP_TITLE" '
            !/^#EXTM3U/ {
              if ($0 ~ /^#EXTINF:-1/) {
                sub(/^#EXTINF:-1/, "#EXTINF:-1 group-title=\"" title "\"");
              }
              print $0
            }
          ' "$TEMP_FILE" >> playlist.m3u
          echo "" >> playlist.m3u
          rm "$TEMP_FILE"

      # 3. Bangladesh (Local File)
      - name: 3. Append Local Bangladesh Group
        run: append_m3u_group "Bangladesh" "Bangladesh"

      # 4. Indian Bangla (Local File)
      - name: 4. Append Local Indian Bangla Group
        run: append_m3u_group "Indian Bangla" "Indian Bangla"

      # 5. Indian Hindi (Local File)
      - name: 5. Append Local Indian Hindi Group
        run: append_m3u_group "Indian Hindi" "Indian Hindi"
          
      # 6. Educational (Local File)
      - name: 6. Append Local Educational Group
        run: append_m3u_group "Educational" "Educational"

      # 7. Sports (General) (Local File)
      - name: 7. Append Local Sports Group (General)
        run: append_m3u_group "Sports" "Sports"

      # 8. Kids (Local File)
      - name: 8. Append Local Kids Group
        run: append_m3u_group "Kids" "Kids"

      # --- ৩. কমিট এবং Push করা ---
      - name: Commit and push if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add playlist.m3u
          git commit -m "Auto-update master playlist with local and external groups" || echo "No changes to commit"
          git push
